name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check-branch.outputs.should-deploy }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Type checking
        run: npm run check

      - name: Build verification
        run: npm run build

      - name: Check if should deploy
        id: check-branch
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  netlify-deploy:
    name: Netlify Deployment
    runs-on: ubuntu-latest
    needs: quality-gate
    if: needs.quality-gate.outputs.should-deploy == 'true'
    outputs:
      deploy-url: ${{ steps.deploy.outputs.deploy-url }}
      deploy-status: ${{ steps.deploy.outputs.status }}
      site-id: ${{ steps.deploy.outputs.site-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Build site
        run: npm run build

      - name: Deploy to Netlify
        id: deploy
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions - ${{ github.event.head_commit.message || github.event.pull_request.title }}'
          enable-pull-request-comment: true
          enable-commit-comment: false
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  netlify-status-monitor:
    name: Netlify Status Monitor
    runs-on: ubuntu-latest
    needs: [quality-gate, netlify-deploy]
    if: always() && needs.quality-gate.outputs.should-deploy == 'true' && github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Netlify deployment status
        id: check-status
        run: |
          if [[ "${{ needs.netlify-deploy.result }}" == "failure" ]]; then
            echo "deployment-failed=true" >> $GITHUB_OUTPUT
          else
            echo "deployment-failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with deployment failure
        if: steps.check-status.outputs.deployment-failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            const comment = `## üö® Netlify Deployment Failed

            The Netlify deployment for this PR has failed. Please check the build logs and fix any issues before the code review can proceed.

            **Common issues to check:**
            - Build errors or compilation failures
            - Missing environment variables
            - Asset or import path issues
            - TypeScript type errors not caught locally

            The Claude Code review will be skipped until the deployment succeeds.

            ---
            *This comment was automatically generated by the CI/CD pipeline.*`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: comment
            });

  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    needs: [quality-gate, netlify-deploy]
    if: needs.quality-gate.result == 'success' && needs.netlify-deploy.result == 'success' && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Please review this pull request and provide feedback ONLY on areas that need improvement. Do not summarize changes or praise good code.

            Focus specifically on identifying:

            üîê **Security Issues:**
            - Potential vulnerabilities or attack vectors
            - Exposed secrets, API keys, or sensitive data
            - Insufficient input validation or sanitization
            - Authentication/authorization flaws

            üìù **Code Quality Issues:**
            - Logic errors or edge cases that could cause malfunctions
            - Code style violations not caught by automated linters
            - Performance bottlenecks or inefficient implementations
            - Missing or inadequate error handling

            üéØ **Requirement Alignment:**
            - Code that doesn't match the original ticket/requirements
            - Missing functionality or incomplete implementations
            - Incorrect behavior or business logic

            ‚ö†Ô∏è **Potential Problems:**
            - Race conditions or concurrency issues
            - Memory leaks or resource management problems
            - Breaking changes or compatibility issues
            - Missing tests for critical functionality

            If you find issues, provide specific suggestions for improvement. If the code looks good with no actionable improvements needed, simply respond with "‚úÖ No issues found - code looks good to merge."

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
